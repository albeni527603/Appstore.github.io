<!DOCTYPE html>
<html lang="ug" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>باشقۇرۇش بېتى</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @font-face {
            font-family: 'ALP';
            src: url('alp.ttf') format('truetype');
            font-display: swap;
        }
        
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --accent-color: #ea4335;
            --dark-color: #202124;
            --light-color: #f8f9fa;
        }
        
        * {
            font-family: 'ALP', 'Noto Sans Arabic', 'Noto Sans Uyghur', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            text-align: right;
            direction: rtl;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
        }
        
        .navbar-brand i {
            margin-left: 10px;
        }
        
        .nav-item {
            margin-left: 15px;
            margin-right: 0;
        }
        
        .admin-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        
        .add-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            color: white;
            font-weight: 500;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .add-btn i {
            margin-left: 8px;
        }
        
        .app-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .app-table th, .app-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        .app-table th {
            background-color: var(--light-color);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .action-btn {
            padding: 6px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .edit-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .delete-btn {
            background-color: var(--accent-color);
            color: white;
        }
        
        .modal-content {
            border-radius: 10px;
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .form-control {
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: right;
        }
        
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .login-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 50px;
            padding: 10px;
            color: white;
            font-weight: 500;
            width: 100%;
        }
        
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            .app-table th, .app-table td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            .action-btn {
                padding: 5px 8px;
                margin: 0 2px;
                font-size: 0.8rem;
            }
            
            .navbar-brand {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- باشقۇرۇش بېتى باشلىقى -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-cog"></i>
                باشقۇرۇش بېتى
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i> تور بەتكە قايتىش</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-btn"><i class="fas fa-sign-out-alt me-1"></i> چىقىش</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- باشقۇرۇش قىسىمى -->
    <div class="container admin-container" id="admin-panel" style="display: none;">
        <h2 class="mb-4"><i class="fas fa-mobile-alt me-2"></i>قوللىنىش باشقۇرۇش</h2>
        
        <button class="add-btn" id="add-app-btn">
            <i class="fas fa-plus me-1"></i> يېڭى قوللىنىش قۇشۇش
        </button>
        
        <div class="table-responsive">
            <table class="app-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ئىسىم</th>
                        <th>سەۋىيە</th>
                        <th>چۈشۈرۈلۈش</th>
                        <th>ئەمەلىيەت</th>
                    </tr>
                </thead>
                <tbody id="apps-table-body">
                    <!-- قوللىنىشلار بۇ يەرگە JavaScript ئارقىلىق قۇرۇلىدۇ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- كىرىش فورمىسى -->
    <div class="container login-container" id="login-form">
        <h2 class="text-center mb-4"><i class="fas fa-lock me-2"></i>كىرىش</h2>
        <form id="loginForm">
            <div class="mb-3">
                <label for="username" class="form-label">ئىشلەتكۇچى ئىسمى</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">پارول</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="login-btn">
                <i class="fas fa-sign-in-alt me-1"></i> كىرىش
            </button>
        </form>
    </div>

    <!-- قوللىنىش قۇشۇش/تەھرىرلەش مودالى -->
    <div class="modal fade" id="appModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle"><i class="fas fa-plus me-1"></i>يېڭى قوللىنىش قۇشۇش</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="appForm">
                        <input type="hidden" id="appId">
                        <div class="mb-3">
                            <label for="appName" class="form-label">قوللىنىش ئىسمى</label>
                            <input type="text" class="form-control" id="appName" required>
                        </div>
                        <div class="mb-3">
                            <label for="appDescription" class="form-label">تەسۋىر</label>
                            <textarea class="form-control" id="appDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="appImageUrl" class="form-label">تەسۋىر ئادرېسى</label>
                            <input type="url" class="form-control" id="appImageUrl" required>
                        </div>
                        <div class="mb-3">
                            <label for="appDownloadUrl" class="form-label">چۈشۈرۈش ئادرېسى</label>
                            <input type="url" class="form-control" id="appDownloadUrl" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="appCategory" class="form-label">سەۋىيە</label>
                                    <select class="form-control" id="appCategory" required>
                                        <option value="tool">قورال</option>
                                        <option value="game">ئويۇن</option>
                                        <option value="social">ئىجتىمائىي</option>
                                        <option value="education">ئوقۇتۇش</option>
                                        <option value="other">باشقا</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="appSize" class="form-label">چوڭلۇقى</label>
                                    <input type="text" class="form-control" id="appSize" placeholder="مەسىلەن: 5.2MB" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="appVersion" class="form-label">نەشرى</label>
                            <input type="text" class="form-control" id="appVersion" placeholder="مەسىلەن: 1.0.0" required>
                        </div>
                        <div class="mb-3">
                            <label for="appRating" class="form-label">باھا (0-5)</label>
                            <input type="number" class="form-control" id="appRating" min="0" max="5" step="0.1" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بىكار قىلىش</button>
                    <button type="button" class="btn btn-primary" id="saveAppBtn">ساقلاش</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JSONBin.io 配置 - 使用您提供的凭据
        const BIN_ID = '6897dc5cd0ea881f40557da9';
        const API_KEY = '6897e1acd0ea881f4055803f'; // 您提供的 X-Access-Key
        
        let apps = [];
        let currentUser = localStorage.getItem('currentUser');
        let isEditMode = false;
        let currentEditId = null;
        
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const appsTableBody = document.getElementById('apps-table-body');
        const appModal = new bootstrap.Modal(document.getElementById('appModal'));
        const appForm = document.getElementById('appForm');
        const modalTitle = document.getElementById('modalTitle');
        const saveAppBtn = document.getElementById('saveAppBtn');
        const addAppBtn = document.getElementById('add-app-btn');
        const logoutBtn = document.getElementById('logout-btn');
        
        // 从JSONBin.io加载应用数据
        async function loadApps() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    headers: {
                        'X-Access-Key': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("从JSONBin加载的数据:", data);
                return data.record || [];
            } catch (error) {
                console.error('加载应用数据失败:', error);
                return [];
            }
        }
        
        // 保存应用到JSONBin.io
        async function saveApps(appsToSave) {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': API_KEY
                    },
                    body: JSON.stringify(appsToSave)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log("保存成功:", result);
                return result;
            } catch (error) {
                console.error('保存应用数据失败:', error);
                throw error;
            }
        }
        
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }
        
        async function checkLogin() {
            if (currentUser) {
                loginForm.style.display = 'none';
                adminPanel.style.display = 'block';
                apps = await loadApps();
                displayAppsTable();
            } else {
                loginForm.style.display = 'block';
                adminPanel.style.display = 'none';
            }
        }
        
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === 'admin123') {
                localStorage.setItem('currentUser', username);
                currentUser = username;
                checkLogin();
            } else {
                alert('ئىشلەتكۇچى ئىسمى ياكى پارول خاتا!');
            }
        });
        
        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            checkLogin();
        });
        
        async function displayAppsTable() {
            appsTableBody.innerHTML = '';
            
            if (apps.length === 0) {
                appsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">قوللىنىش يوق</td></tr>';
                return;
            }
            
            apps.forEach(app => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${app.id}</td>
                    <td>${app.name}</td>
                    <td>${app.category === 'tool' ? 'قورال' : 
                         app.category === 'game' ? 'ئويۇن' : 
                         app.category === 'social' ? 'ئىجتىمائىي' : 
                         app.category === 'education' ? 'ئوقۇتۇش' : 'باشقا'}</td>
                    <td>${app.downloadCount || 0} قېتىم</td>
                    <td>
                        <button class="action-btn edit-btn" data-id="${app.id}">
                            <i class="fas fa-edit me-1"></i> تەھرىرلەش
                        </button>
                        <button class="action-btn delete-btn" data-id="${app.id}">
                            <i class="fas fa-trash me-1"></i> ئۆچۈرۈش
                        </button>
                    </td>
                `;
                appsTableBody.appendChild(tr);
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    editApp(parseInt(this.getAttribute('data-id')));
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    if (confirm('بۇ قوللىنىشنى ئۆچۈرەمسىز؟')) {
                        await deleteApp(parseInt(this.getAttribute('data-id')));
                    }
                });
            });
        }
        
        addAppBtn.addEventListener('click', function() {
            isEditMode = false;
            currentEditId = null;
            appForm.reset();
            modalTitle.innerHTML = '<i class="fas fa-plus me-1"></i>يېڭى قوللىنىش قۇشۇش';
            saveAppBtn.textContent = 'قۇشۇش';
            appModal.show();
        });
        
        function editApp(id) {
            const app = apps.find(app => app.id === id);
            if (!app) return;
            
            isEditMode = true;
            currentEditId = id;
            
            document.getElementById('appId').value = app.id;
            document.getElementById('appName').value = app.name;
            document.getElementById('appDescription').value = app.description;
            document.getElementById('appImageUrl').value = app.imageUrl;
            document.getElementById('appDownloadUrl').value = app.downloadUrl;
            document.getElementById('appCategory').value = app.category;
            document.getElementById('appSize').value = app.size;
            document.getElementById('appVersion').value = app.version;
            document.getElementById('appRating').value = app.rating || 4.0;
            
            modalTitle.innerHTML = '<i class="fas fa-edit me-1"></i>قوللىنىشنى تەھرىرلەش';
            saveAppBtn.textContent = 'يېڭىلاش';
            appModal.show();
        }
        
        saveAppBtn.addEventListener('click', async function() {
            const id = isEditMode ? currentEditId : Date.now();
            const name = document.getElementById('appName').value;
            const description = document.getElementById('appDescription').value;
            const imageUrl = document.getElementById('appImageUrl').value;
            const downloadUrl = document.getElementById('appDownloadUrl').value;
            const category = document.getElementById('appCategory').value;
            const size = document.getElementById('appSize').value;
            const version = document.getElementById('appVersion').value;
            const rating = parseFloat(document.getElementById('appRating').value);
            
            if (!name || !description || !imageUrl || !downloadUrl || !category || !size || !version || isNaN(rating)) {
                alert('بارلىق سۆز بۆلەكلەرنى تولدۇرۇڭ!');
                return;
            }
            
            if (!isValidUrl(downloadUrl)) {
                alert('چۈشۈرۈش ئادرېسى توغرا ئەمەس!');
                return;
            }
            
            if (!isValidUrl(imageUrl)) {
                alert('تەسۋىر ئادرېسى توغرا ئەمەس!');
                return;
            }
            
            if (!version.match(/^\d+(\.\d+){1,2}$/)) {
                alert('نەشرى توغرا ئەمەس (مەسىلەن: 1.0.0)');
                return;
            }
            
            if (!size.match(/^\d+(\.\d+)?\s*[KM]B$/i)) {
                alert('چوڭلۇقى توغرا ئەمەس (مەسىلەن: 5.2MB)');
                return;
            }
            
            if (rating < 0 || rating > 5) {
                alert('باھا 0 دىن 5 گىچە بولۇشى كېرەك!');
                return;
            }
            
            const newApp = {
                id,
                name,
                description,
                imageUrl,
                downloadUrl,
                category,
                size,
                version,
                rating,
                downloadCount: isEditMode ? (apps.find(app => app.id === id)?.downloadCount || 0) : 0
            };
            
            if (isEditMode) {
                const index = apps.findIndex(app => app.id === currentEditId);
                if (index !== -1) {
                    apps[index] = newApp;
                }
            } else {
                apps.push(newApp);
            }
            
            try {
                await saveApps(apps);
                displayAppsTable();
                appModal.hide();
            } catch (error) {
                alert('ساقلاش مەغلۇپ بولدى: ' + error.message);
            }
        });
        
        async function deleteApp(id) {
            apps = apps.filter(app => app.id !== id);
            try {
                await saveApps(apps);
                displayAppsTable();
            } catch (error) {
                alert('ئۆچۈرۈش مەغلۇپ بولدى: ' + error.message);
            }
        }
        
        document.addEventListener('DOMContentLoaded', checkLogin);
    </script>
</body>
</html>